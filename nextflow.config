/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    FlorPio/hrprofiler Nextflow config file
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
*/

// Global default params
params {
    // Input/Output
    input                   = null
    outdir                  = './results'
    
    // HRProfiler parameters
    hrd_script              = "${projectDir}/bin/HRD.py"
    organ                   = 'BREAST'      // BREAST or OVARIAN
    genome                  = 'GRCh38'
    cnv_file_type           = 'ASCAT'       // ASCAT, SEQUENZA, FACETS, PURPLE
    hrd_threshold           = 0.5
    
    // Genome reference path (for lightweight container)
    // Set this if using florpio/hrprofiler:1.0 (without genome)
    // Leave null if using florpio/hrprofiler:1.0-full
    genome_path             = null          // e.g., '/home/user/hrprofiler_genome'
    
    // VCF filtering parameters
    min_dp                  = 10            // Minimum depth in tumor
    min_af                  = 0.05          // Minimum allele frequency in tumor
    
    // Skip options
    skip_vcf_filter         = false
    skip_segment_prep       = false
    
    // Boilerplate options
    publish_dir_mode        = 'copy'
    monochrome_logs         = false
    help                    = false
    version                 = false
    validate_params         = true
    show_hidden_params      = false
}

// Load base.config by default for all pipelines
process {
    // Default resources
    cpus   = 1
    memory = 4.GB
    time   = 4.h

    // Error handling
    errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'finish' }
    maxRetries    = 1
    maxErrors     = '-1'

    // Process-specific resources
    withLabel: 'process_single' {
        cpus   = 1
        memory = 4.GB
    }
    
    withLabel: 'process_low' {
        cpus   = 2
        memory = 8.GB
    }
    
    withLabel: 'process_medium' {
        cpus   = 4
        memory = 16.GB
    }

    // Publish directories
    withName: 'FILTER_VCF' {
        publishDir = [
            path: { "${params.outdir}/filtered_vcfs" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
    
    withName: 'PREPARE_SEGMENTS' {
        publishDir = [
            path: { "${params.outdir}/prepared_segments" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
    
    withName: 'HRPROFILER' {
        publishDir = [
            path: { "${params.outdir}/hrprofiler" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
        // HRProfiler puede necesitar más memoria
        memory = 16.GB
    }
}

// Profiles
profiles {
    debug {
        dumpHashes             = true
        process.beforeScript   = 'echo $HOSTNAME'
        cleanup                = false
    }
    
    docker {
        docker.enabled         = true
        conda.enabled          = false
        singularity.enabled    = false
        // Para montar el genoma, usar: -profile docker --genome_path /path/to/genome
        // Y agregar en línea de comandos: -with-docker '-v /path/to/genome:/root/.SigProfilerMatrixGenerator'
    }
    
    singularity {
        singularity.enabled    = true
        singularity.autoMounts = true
        conda.enabled          = false
        docker.enabled         = false
    }
    
    conda {
        conda.enabled          = true
        docker.enabled         = false
        singularity.enabled    = false
    }
    
    test {
        params.input           = "${projectDir}/assets/test_samplesheet.csv"
        params.outdir          = './results_test'
    }
}

// Export environment variables
env {
    PYTHONNOUSERSITE = 1
}

// Capture exit codes from upstream processes when piping
process.shell = ['/bin/bash', '-euo', 'pipefail']

// Manifest
manifest {
    name            = 'FlorPio/hrprofiler'
    author          = 'Flor Pio'
    homePage        = 'https://github.com/FlorPio/hrprofiler'
    description     = 'HRD Analysis Pipeline using HRProfiler'
    mainScript      = 'main.nf'
    nextflowVersion = '!>=23.04.0'
    version         = '1.0.0'
}

// Logging
def trace_timestamp = new java.util.Date().format('yyyy-MM-dd_HH-mm-ss')
timeline {
    enabled = true
    file    = "${params.outdir}/pipeline_info/execution_timeline_${trace_timestamp}.html"
}
report {
    enabled = true
    file    = "${params.outdir}/pipeline_info/execution_report_${trace_timestamp}.html"
}
trace {
    enabled = true
    file    = "${params.outdir}/pipeline_info/execution_trace_${trace_timestamp}.txt"
}
